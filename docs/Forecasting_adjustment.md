# Adjustment Methods in Forecasting Mode
In forecasting mode, rain gauges are not available to correct the gridded rainfall product(s), as future forecast rainfall is not observed yet. This means that the adjustment methods in hindcasting mode (using rain gauge observations) are not possible and that we thus should use a different approach to correct our precipitation forecasts. Quantile mapping, also referred to as quantile regression, is currently one of the most widely used and advanced precipitation forecast correction methods (e.g. Gudmundsson et al. 2012). 

Quantile mapping is a correction method that considers the variability of bias throughout the distribution of the target variable. Rather than only correcting the mean values of the data, quantile mapping can assess the degree to which lower, higher or extreme values need to be adjusted to match the target distribution of a reference dataset. 

There are a variety of quantile mapping methods available (Cannon et al., 2015), each with differing degrees of complexity. There are parametric approaches, that fit distributions on the original and reference datasets. Benefits are that the method can extend into the parts of the distribution that the sample would not cover itself and it can account for trends within the sample, for example the climate signal. However, that also poses challenges with extrapolation and selection the right parametric model to fit the distributions.

Instead, a relatively simple and robust method is to apply quantile mapping using the empirical cumulative density function, which in essence finds the values of both forecast and reference data at a regular quantile interval (each percentile, for example) throughout a reference period. Afterwards, it computes adjustment factors for each quantile of the distribution (see the figure below). A forecast that falls in between percentiles will find the required correction by linearly interpolating between the adjustment factors. This poses a challenge for the extremes, where a forecast value that was larger than the maximum in the reference period will be extrapolated, which is not always accurate. At the same time, this method assumes stationarity of the distribution in the future, which seldomly holds in environmental forecasting due to the effects of climate change. Even though these concerns exist, the simplicity of the methodology and its robustness are the main reasons for its widespread adoption. These reasons are also our main rationale to implement the empirical cumulative density function-based quantile mapping in pyRainAdjustment.

![image](https://github.com/user-attachments/assets/9181790d-5ee8-4bed-93e6-1b1f1cd5e656)
Example of empirical quantile mapping (from Ringard et al., 2017)

## Quantile mapping in pyRaindAdjustment
PyRainAdjustment approaches quantile mapping with a few standard options. It will group all historic forecasts and reference data based on the forecast month. This means that all forecasts with an issue time ($$t_{0}$$) in, for instance, March will be corrected based on the distributions of historic forecasts and reference data from March. Thus, a forecast that starts at the end of March and extends into April will only be using the March correction factors. 

The method requires a few arguments to be able to run. First of all, the argument `derive_qmapping_factors` needs to be passed to indicate whether new correction files, which form the basis of the method in forecasting mode, need to be computed. If that is the case, pay attention that the forecast time is right at the end of your historic reference period, otherwise parts of the reference period will be missing or data outside of the period might accidentally be included (also note that the exported forecasts should match the time span of the reference data, because pyRainAdjustment does currently not check for that). 

Standard, pyRainAdjustment will store correction factors for all lead times together, meaning that it will provide one correction factor that is the same for all lead times, but that varies based on the location in the grid and the month of the issue time. However, the argument `leadtime_specific` (by default `False`) can be overwritten to compute correction factors for each leadtime within the provided data. Depending on the provided data, this might be prone to overfitting, which is why it is set to `False` by default.

Once the quantile mapping correction factors have been derived, they are stored in a separate folder, which can be defined by the user or, otherwise, they will be automatically placed in a folder called `qq_correction_factors` in the pyRainAdjustment module folder. From here on, the quantile mapping workflow can be called with `derive_qmapping_factors` set to `False` and by providing a forecast. Based on that, pyRainAdjustment will search for the month corresponding to the issue time of the forecast and the right lead times (if `leadtime_specific` is `True`). The gridded rainfall forecast is then corrected based on the quantile the forecast for each grid cell falls in. For all configuration options, see [/config/README.md](https://github.com/Deltares-research/pyRainAdjustment/tree/main/config/README.md).

![image](https://github.com/user-attachments/assets/f0b0bf69-5276-4ab9-ab57-fa8e2e574394)
Original forecast (left) and corrected forecast using quantile mapping in Delft-FEWS (right) for Southeastern Australia as issued on 2022-03-18 11:00. Shown are the forecasts for lead time 2024-03-20 01:00 local time. 

## Usage in Delft-FEWS
Examples of how to configure these options in Delft-FEWS are provided in the folder `config` and this is further explained in [/config/README.md](https://github.com/Deltares-research/pyRainAdjustment/tree/main/config/README.md). For quantile mapping, have a look at [/config/ModuleConfigFiles/Process_Determine_QuantileMapping.xml](https://github.com/Deltares-research/pyRainAdjustment/tree/main/config/ModuleConfigFiles/Process_Determine_QuantileMapping.xml) and [/config/ModuleConfigFiles/Process_Apply_QuantileMapping.xml](https://github.com/Deltares-research/pyRainAdjustment/tree/main/config/ModuleConfigFiles/Process_Apply_QuantileMapping.xml). The different adjustment methods can be provided to the Delft-FEWS model adapter (General Adapter) by providing the property key `adjustment_method`, which can be one of the following methods: `MFB`, `additive`, `multiplicative`, `mixed`, `KED` and `quantile_mapping`.

The output of the hindcasting adjusmtent procedure is one netCDF file, which is placed in the `FromModel` folder and can be directly read by Delft-FEWS. This netCDF (`corrected_forecast.nc`) contains the `multiplier` adjustment variable and the adjusted rainfall field variable (`P`). 

In addition, more information and a schematic of how pyRainAdjustment interacts with Delft-FEWS can be found in the [Delft-FEWS public wiki page of pyRainAdjusment](https://publicwiki.deltares.nl/spaces/FEWSDOC/pages/366444650/Correction+methods+in+forecasting+mode). 

## References
Cannon, Alex J., Stephen R. Sobie, and Trevor Q. Murdock. ‘Bias Correction of GCM Precipitation by Quantile Mapping: How Well Do Methods Preserve Changes in Quantiles and Extremes?’, 1 September 2015. https://doi.org/10.1175/JCLI-D-14-00754.1.

Gudmundsson, L., J. B. Bremnes, J. E. Haugen, and T. Engen-Skaugen. ‘Technical Note: Downscaling RCM Precipitation to the Station Scale Using Statistical Transformations &ndash; a Comparison of Methods’. Hydrology and Earth System Sciences 16, no. 9 (21 September 2012): 3383–90. https://doi.org/10.5194/hess-16-3383-2012.

Ringard, Justine, Frederique Seyler, and Laurent Linguet. ‘A Quantile Mapping Bias Correction Method Based on Hydroclimatic Classification of the Guiana Shield’. Sensors 17, no. 6 (June 2017): 1413. https://doi.org/10.3390/s17061413.
